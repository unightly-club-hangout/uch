<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome | UCH Main</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="unightly-icon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e0f2fe;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --background: #0f172a;
            --container-bg: rgba(30, 41, 59, 0.8);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --radius: 12px;
            --font-family: 'Poppins', sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background: var(--background);
            color: var(--primary);
        }

        header {
            background: rgba(30, 41, 59, 0.9);
            color: var(--primary);
            padding: 20px;
            position: relative;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 16px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
            background: #fff;
            object-fit: contain;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: center;
        }

        #profile-container {
            position: absolute;
            top: 20px;
            right: 32px;
            z-index: 100;
        }

        #profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 0 4px #aaa;
            border: 2px solid #fff;
            background: #eee;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        #profile-icon:active,
        #profile-icon:focus {
            box-shadow: 0 0 8px var(--accent);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: var(--container-bg);
            color: var(--primary);
            min-width: 180px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 8px 0;
            font-size: 1rem;
            animation: fadeInMenu 0.2s;
        }

        .dropdown-menu.show {
            display: block;
        }

        @keyframes fadeInMenu {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: background 0.15s;
            color: var(--primary);
        }

        .dropdown-item:hover {
            background: rgba(45, 55, 72, 0.6);
            color: var(--accent);
        }

        .dropdown-item.signout {
            border-top: 1px solid rgba(75, 85, 99, 0.4);
            margin-top: 6px;
            color: #fca5a5;
        }

        .dropdown-item.disabled {
            color: #6b7280;
            /* Grey out the text */
            cursor: not-allowed;
            /* Change the cursor */
        }

        .dropdown-item.disabled:hover {
            background: none;
            /* Remove hover effect */
            color: #6b7280;
            /* Keep greyed out */
        }

        /* New Feed Styles */
        #feed-container {
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            background: var(--container-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            color: var(--primary);
        }

        #post-form {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        #post-text {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(75, 85, 99, 0.6);
            border-radius: 6px;
            background: rgba(45, 55, 72, 0.3);
            color: var(--primary);
            font-size: 1rem;
            resize: vertical;
            /* Allow vertical resizing */
        }

        #file-input {
            margin-bottom: 10px;
            color: var(--primary);
            /* Hide the default file input button */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
            display: inline-block;
        }

        .file-input-button:hover {
            background: var(--accent-hover);
            box-shadow: 0 6px 18px rgba(59, 130, 246, 0.5);
        }

        #post-button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }

        #post-button:hover {
            background: var(--accent-hover);
            box-shadow: 0 6px 18px rgba(59, 130, 246, 0.5);
        }

        .post {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: var(--radius);
            background: rgba(45, 55, 72, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            word-wrap: break-word;
            /* Prevent long words from breaking the layout */
            position: relative;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-header img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .post-content {
            margin-bottom: 10px;
        }

        .post-image,
        .post-video {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            /* Ensure images and videos don't overflow */
            max-height: 400px;
            /* Set a maximum height */
            object-fit: contain;
            /* Maintain aspect ratio and fit within the container */
        }

        .post-video {
            max-height: 400px;
            /* Limit video height */
        }

        #preview-container {
            max-width: 100%;
        }

        #preview-container img,
        #preview-container video {
            max-width: 100%;
            /* Ensure images and videos don't overflow */
            max-height: 300px;
            /* Set a maximum height */
            object-fit: contain;
            /* Maintain aspect ratio and fit within the container */
            margin-bottom: 10px;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            /* Red color */
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c53030;
            /* Darker red */
        }

        /* Responsive Styles */
        @media (max-width: 600px) {
            #feed-container {
                margin: 20px;
                padding: 15px;
            }

            header {
                padding: 16px;
                /* Reduce padding for smaller screens */
            }

            .header-icon {
                width: 32px;
                height: 32px;
                margin-right: 8px;
                /* Reduce margin for smaller screens */
            }

            .header-title {
                font-size: 1.2rem;
                /* Reduce font size for smaller screens */
            }

            #profile-container {
                top: 12px;
                right: 12px;
            }

            #profile-icon {
                width: 32px;
                height: 32px;
            }
        }
    </style>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXbIvGZn0vQpRlrBhL6RFyGg-NGGDpTSY",
            authDomain: "unightly-club-hangout-56361.firebaseapp.com",
            databaseURL: "https://unightly-club-hangout-56361-default-rtdb.firebaseio.com",
            projectId: "unightly-club-hangout-56361",
            storageBucket: "unightly-club-hangout-56361.firebasestorage.app",
            messagingSenderId: "41004307513",
            appId: "1:41004307513:web:d511cfba74cc008c96a9e8",
            measurementId: "G-6JZ4GR0CGC",
        };

        let app;
        let db;
        let storage;
        let auth;
        let authorizedEmails = [];
        let fileType;
        let mediaUrl;

        try {
            // Initialize Firebase
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            storage = firebase.storage();
            auth = firebase.auth();
            console.log("Firebase initialized successfully!");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Handle the error appropriately (e.g., display an error message to the user)
        }

        const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/silentmason/Unightly-Club-Hangout/refs/heads/main/UCHstaff.json';

        async function fetchAuthorizedEmails() {
            try {
                const response = await fetch(GITHUB_RAW_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                authorizedEmails = await response.json();
                console.log("Authorized emails fetched successfully:", authorizedEmails);
            } catch (error) {
                console.error('Failed to fetch authorized emails:', error);
                authorizedEmails = []; // Ensure authorizedEmails is an array even on failure
            }
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        window.onload = async function () {
            let img;
            let menu;
            let container;
            let userEmail;
            let userName;
            let userPicture;
            let adminButton;

            const credential = localStorage.getItem('google_credential');

            if (credential) {
                const payload = parseJwt(credential);

                if (payload.picture) {
                    // Create profile container
                    container = document.createElement('div');
                    container.id = 'profile-container';

                    // Create profile icon
                    img = document.createElement('img');
                    img.id = 'profile-icon';
                    img.src = payload.picture;
                    img.alt = 'Google Profile';
                    img.tabIndex = 0;

                    // Create dropdown menu
                    menu = document.createElement('div');
                    menu.className = 'dropdown-menu';
                    menu.innerHTML = `
                        <div class="dropdown-item" id="account-settings-link">Account settings</div>
                        <div class="dropdown-item">Profile</div>
                        <div class="dropdown-item">Friends</div>
                        <div class="dropdown-item disabled" id="status-link">Status</div>
                        <div class="dropdown-item signout" id="signout-link">Sign Out</div>
                    `;

                    // Toggle menu on icon click
                    img.onclick = function (e) {
                        e.stopPropagation();
                        menu.classList.toggle('show');
                    };

                    img.onblur = function () {
                        setTimeout(() => menu.classList.remove('show'), 150);
                    };

                    // Hide menu when clicking outside
                    document.addEventListener('click', function () {
                        menu.classList.remove('show');
                    });

                    // Account settings click
                    menu.querySelector('#account-settings-link').onclick = function (e) {
                        e.stopPropagation();
                        menu.classList.remove('show');
                        window.location.href = 'account-settings.html';
                    };

                    // Status click - PREVENT ACTION
                    menu.querySelector('#status-link').onclick = function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        menu.classList.remove('show');
                        return false;
                    };

                    // Sign out click
                    menu.querySelector('#signout-link').onclick = function (e) {
                        e.stopPropagation();
                        localStorage.removeItem('google_credential');
                        window.location.href = 'index.html';
                    };

                    container.appendChild(img);
                    container.appendChild(menu);
                    document.body.appendChild(container);

                    userEmail = payload.email;
                    userName = payload.name;
                    userPicture = payload.picture;
                }
            }

            const feedContainer = document.getElementById('feed-container');

            // Load authorized emails and then render the page
            await fetchAuthorizedEmails();
            let isAuthorized = authorizedEmails.includes(userEmail);

            // Add Admin Dashboard Button if Authorized
            // Check if the adminButton already exists
            adminButton = document.getElementById('adminDashboardButton');
            if (isAuthorized) {
                if (!adminButton) {
                    adminButton = document.createElement('a');
                    adminButton.id = 'adminDashboardButton'; // Add an ID to the button
                    adminButton.href = 'https://silentmason.github.io/uch/Dashboard.html'; // Replace with the actual URL
                    adminButton.textContent = 'Admin Dashboard';
                    adminButton.style.cssText = `
                        background-color: var(--accent);
                        color: #fff;
                        padding: 10px 15px;
                        border-radius: var(--radius);
                        text-decoration: none;
                        margin-left: 20px;
                        transition: background-color 0.2s;
                    `;
                    adminButton.onmouseover = function () {
                        this.style.backgroundColor = 'var(--accent-hover)';
                    };
                    adminButton.onmouseout = function () {
                        this.style.backgroundColor = 'var(--accent)';
                    };
                    document.querySelector('header').appendChild(adminButton);
                }
            } else {
                // Remove the button if the user is not authorized
                if (adminButton) {
                    adminButton.remove();
                }
            }

            let formHTML = '';

            if (isAuthorized) {
                formHTML = `
                    <form id="post-form">
                        <textarea id="post-text" placeholder="What's on your mind?" rows="4"></textarea>
                        <div id="preview-container"></div>
                        <div class="file-input-wrapper">
                            <button class="file-input-button" type="button" onclick="document.getElementById('file-input').click()">Choose file</button>
                            <input type="file" id="file-input" accept="image/*, video/*" onchange="handleFileChange(event)" style="display:none;">
                        </div>
                        <button type="submit" id="post-button">Post</button>
                    </form>
                `;
            } else {
                formHTML = `<p>Official UCH Staff may post.</p>`;
            }

            feedContainer.innerHTML = `
                <h1>Welcome to the UCH Feed!</h1>
                ${formHTML}
            `;

            // Post Submission
            // Function to handle file selection
            window.handleFileChange = function (event) {
                const file = event.target.files[0];
                const previewContainer = document.getElementById('preview-container');

                if (file) {
                    fileType = file.type;

                    if (fileType.startsWith('image/') || fileType.startsWith('video/')) {
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            mediaUrl = e.target.result;
                            let previewContent = '';

                            if (fileType.startsWith('image/')) {
                                previewContent = `<img src="${mediaUrl}" alt="Post Image" id="preview-image">`;
                            } else if (fileType.startsWith('video/')) {
                                previewContent = `<video src="${mediaUrl}" alt="Post Video" controls></video>`;
                            }

                            previewContainer.innerHTML = previewContent;
                        };

                        reader.readAsDataURL(file); // Read file as Data URL
                    } else {
                        alert('Invalid file type. Only images and videos are allowed.');
                        fileInput.value = '';
                        previewContainer.innerHTML = '';
                        mediaUrl = null;
                        fileType = null;
                        return;
                    }
                } else {
                    previewContainer.innerHTML = '';
                    mediaUrl = null;
                    fileType = null;
                }
            }

            const postForm = document.getElementById('post-form');

            if (postForm) {
                const previewContainer = document.getElementById('preview-container');
                const postText = document.getElementById('post-text');

                postForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const text = postText.value.trim();
                    const fileInput = document.getElementById('file-input'); // Get file input inside the submit handler
                    const file = fileInput.files[0];

                    if (text !== '' || file) { // Check if there's text or a file
                        // Upload media to Firebase Storage if it exists
                        let mediaUrlFirebase = null;

                        if (file) {
                            try {
                                const storageRef = storage.ref(`posts/${Date.now()}_${file.name}`);
                                const uploadTask = storageRef.putString(mediaUrl, 'data_url');
                                mediaUrlFirebase = await uploadTask.then(async (snapshot) => {
                                    return await snapshot.ref.getDownloadURL();
                                });
                            } catch (uploadError) {
                                console.error("Error uploading to Firebase Storage:", uploadError);
                                return; // Stop the post submission if the upload fails
                            }
                        }

                        const newPost = {
                            text: text,
                            mediaUrl: mediaUrlFirebase,
                            mediaType: fileType,
                            userName: userName,
                            userPicture: userPicture
                        };

                        // Push post to Firebase Database
                        try {
                            db.ref('posts').push(newPost)
                                .then(() => {
                                    console.log('Post added to Firebase!');
                                    postText.value = ''; // Clear the text input
                                    fileInput.value = ''; // Clear the file input
                                    previewContainer.innerHTML = ''; // Clear the preview
                                    mediaUrl = null;
                                    fileType = null;
                                })
                                .catch((error) => {
                                    console.error("Error adding post to Firebase:", error);
                                });
                        } catch (dbError) {
                            console.error("Error writing to Firebase Database:", dbError);
                        }
                    }
                });
            }

            function deletePost(postId) {
                //remove
                //posts = posts.filter(post => post.id !== postId);
                //localStorage.setItem('posts', JSON.stringify(posts));
                //renderPosts(posts, feedContainer, isAuthorized, userPicture, userName); // Re-render the feed
            }

            // Function to render posts from Firebase
            async function renderPostsFromFirebase(feedContainer, isAuthorized, userPicture, userName) {
                if (!db) {
                    console.error("Firebase database not initialized.");
                    return;
                }

                const postsRef = db.ref('posts');

                try {
                    const snapshot = await postsRef.once('value'); // Use .once to get data once
                    const posts = snapshot.val();
                    let postsArray = [];

                    if (posts) {
                        postsArray = Object.entries(posts).map(([key, value]) => ({
                            ...value,
                            id: key,
                        })); // Include the key as the ID
                    }

                    renderPostsContent(postsArray, feedContainer, isAuthorized, userPicture, userName);
                } catch (error) {
                    console.error("Error fetching posts from Firebase:", error);
                }
            }

            function renderPostsContent(posts, feedContainer, isAuthorized, userPicture, userName) {
                let postsHTML = '';

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post';

                    let postHeader = `<div class="post-header">
                        <img src="${post.userPicture}" alt="${post.userName}"'s Profile Picture">
                        <p>${post.userName}</p>
                    </div>`;

                    let postContent = '';

                    if (post.text) {
                        postContent += `<div class="post-content">${post.text}</div>`;
                    }

                    if (post.mediaUrl) {
                        if (post.mediaType && post.mediaType.startsWith('image/')) {
                            postContent += `<img src="${post.mediaUrl}" alt="Post Image" class="post-image">`;
                        } else if (post.mediaType && post.mediaType.startsWith('video/')) {
                            postContent += `<video src="${post.mediaUrl}" alt="Post Video" controls class="post-video"></video>`;
                        }
                    }

                    let deleteButtonHTML = '';

                    if (isAuthorized) {
                        deleteButtonHTML = `<button class="delete-btn" data-id="${post.id}" onclick="deletePost('${post.id}')">x</button>`;
                    }

                    postElement.innerHTML = postHeader + postContent + deleteButtonHTML;
                    postsHTML += postElement.outerHTML;
                });

                feedContainer.innerHTML += postsHTML;
            }

            //Load posts
            renderPostsFromFirebase(feedContainer, isAuthorized, userPicture, userName)
        };

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
</head>
<body>
    <header>
        <img src="unightly-icon.ico" alt="Unightly Icon" class="header-icon">
        <span class="header-title">UCH Website</span>
    </header>
    <!-- Feed Container -->
    <div id="feed-container">
        <!-- Posts will be loaded here -->
    </div>
</body>
</html>